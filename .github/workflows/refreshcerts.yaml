name: Refreshcerts
on:
  workflow_dispatch:
  schedule:
    - cron: '39 7 15 * *' # At 0739 on the 15th day of every month
  push:
    branches:
      - cert_renewal
jobs:
  refresh-ACME-cert:
    runs-on: ubuntu-latest
    name: Set up Python and pull Acme script from Artifact
    steps:
      # checkout at_server code
      - name: checkout repo content
        uses: actions/checkout@v3.1.0 # checkout the repository content to github runner.
      # setup python
      - name: Set up Python 
        uses: actions/setup-python@v3
        with:
          python-version: 3.9 #install the python needed
      - name: setup certinfo
        uses: atsign-company/certinfo-action@v1
      # Pull ZeroSSL and Letsencrypt keys file from secret
      - name: Pull ACME script
        uses: actions/checkout@v3
        with:
          repository: atsign-company/secondaries-scripts
          path: secondaries-scripts
          token: ${{ secrets.MY_GITHUB_TOKEN }}
          ref: trunk
      # Create required directory
      - name: Create required directory and pull secrets
        run: |-
          sudo mkdir -p /gluster/@/api/keys
          sudo chmod -R 777 /gluster/@/api/keys
          echo "${{secrets.LETSENCRYPT_KEY}}" > /gluster/@/api/keys/letsencrypt.key
          echo "${{secrets.ZEROSSL_PRIVATE_KEY}}" > /gluster/@/api/keys/zerossl.key
          echo "${{secrets.GOOGLE_PRIVATE_KEY}}" > /gluster/@/api/keys/google.key
      # Install Python Libraries
      - name: Install Python Libraries
        run: |-
          python3 -m pip install requests dnspython
      # Run Python ACME script
      - name: Run ACME script
        run: |-
          set +e
          FQDN="vip.ve.atsign.zone"
          chmod -R 777 secondaries-scripts
          cd secondaries-scripts && ./create_cert_workflow.sh "$FQDN"
          cp cert.pem ./tools/build_virtual_environment/ve_base/contents/atsign/root/certs/cert.pem
          cp privkey.key ./tools/build_virtual_environment/ve_base/contents/atsign/root/certs/privkey.pem
          cp fullchain.pem ./tools/build_virtual_environment/ve_base/contents/atsign/root/certs/fullchain.pem
          cp ./tools/build_virtual_environment/ve_base/contents/atsign/root/certs/*.pem \
            ./tools/build_virtual_environment/ve_base/contents/atsign/secondary/base/certs/
          ls 
          cd ..
          ls
          set -e
        env:
          DO_KEY: ${{ secrets.DO_KEY }}
          gChat_url: ${{ secrets.GCHAT_PROD_URL }}

      # # create PR with renewed certificate
      # - name: Create Pull Request
      #   id: cpr
      #   uses: peter-evans/create-pull-request@v4
      #   with:
      #     token: ${{ secrets.MY_GITHUB_TOKEN }}
      #     commit-message: 'chore: New certificates for at_server'
      #     committer: library-action[bot] <41898282+github-actions[bot]@users.noreply.github.com>
      #     author: library-action[bot] <41898282+github-actions[bot]@users.noreply.github.com>
      #     signoff: false
      #     add-paths: ./tools/build_virtual_environment
      #     branch: bot-new-certs
      #     delete-branch: true
      #     title: 'chore: New certificates generated'
      #     body: |
      #       Fresh certificates generated.
      #     labels: |
      #       operations
      #     assignees: cpswan
      #     reviewers: gkc
      #     draft: false          
